name: Deploy to VPS

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  deploy:
    runs-on: [self-hosted]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Create .env file
      run: |
        cat > .env << EOF
        DOMAIN=${{ vars.DOMAIN }}
        CONTAINER_NAME=${{ vars.CONTAINER_NAME }}
        IMAGE_TAG=latest
        TRAEFIK_ROUTER_NAME=${{ vars.TRAEFIK_ROUTER_NAME }}
        TRAEFIK_CERT_RESOLVER=${{ vars.TRAEFIK_CERT_RESOLVER }}
        TRAEFIK_ENTRYPOINT=${{ vars.TRAEFIK_ENTRYPOINT }}
        CONTAINER_PORT=80
        EOF
    
    - name: Create Traefik network if missing
      run: |
        docker network inspect traefik >/dev/null 2>&1 || docker network create traefik
    
    - name: Build and deploy
      run: |
        docker-compose down || true
        docker-compose build --no-cache
        docker-compose up -d
    
    - name: Clean up old images
      run: |
        docker image prune -f
    
    - name: Verify deployment
      run: |
        docker-compose ps